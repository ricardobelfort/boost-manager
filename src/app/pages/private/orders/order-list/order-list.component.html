<app-breadcrumb [items]="breadcrumb" />
<div class="bg-white rounded-xl shadow-sm p-8">
  <div class="flex flex-col md:flex-row items-center justify-between mb-4 gap-4">
    <div>
      <h2 class="!text-3xl font-bold text-black">Orders</h2>
      <p class="text-gray-500">Here you can view all orders placed.</p>
    </div>
    <div class="flex gap-2 w-full md:w-auto">
      <p-iconfield>
        <p-inputicon styleClass="pi pi-search" />
        <input type="text" pInputText [(ngModel)]="search" placeholder="Search..." />
      </p-iconfield>
      <p-button label="New Order" icon="pi pi-plus" [routerLink]="['select-game']" />
    </div>
  </div>

  <p-divider />

  <p-table
    [value]="filteredOrders"
    [paginator]="true"
    [rows]="10"
    [rowsPerPageOptions]="[10, 20, 50]"
    [responsiveLayout]="'scroll'"
    [showCurrentPageReport]="true"
    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} Orders"
  >
    <ng-template pTemplate="header">
      <tr>
        <th class="!text-gray-400">Booster</th>
        <th class="!text-gray-400">Service</th>
        <th class="!text-gray-400">#Order</th>
        <th class="!text-gray-400" pSortableColumn="status">Status <p-sortIcon field="status" /></th>
        <th class="!text-gray-400" pSortableColumn="start_date">Start <p-sortIcon field="start_date" /></th>
        <th class="!text-gray-400" pSortableColumn="end_date">End <p-sortIcon field="end_date" /></th>
        <th class="!text-gray-400" pSortableColumn="total_value">Total <p-sortIcon field="total_value" /></th>
        <th class="!text-gray-400" pSortableColumn="booster_value">
          Booster Price <p-sortIcon field="booster_value" />
        </th>
        <th class="!text-gray-400">Actions</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-order>
      <tr>
        <td class="text-sm">{{ order.booster }}</td>
        <td class="text-sm">{{ order.service_type }}</td>
        <td class="text-sm">#{{ order.order_number }}</td>
        <td class="text-sm">
          <span
            class="px-2 py-1 rounded-lg font-medium"
            [ngClass]="{
              'bg-yellow-100 text-yellow-800': order.status === 'Aguardando',
              'bg-blue-100 text-blue-800': order.status === 'In progress',
              'bg-blue-100 text-red-800': order.status === 'Suspected ban',
              'bg-green-100 text-green-800': order.status === 'Concluído',
            }"
          >
            {{ order.status }}
          </span>
        </td>
        <td class="text-sm">{{ order.start_date ? (order.start_date | date: 'dd/MM/yy' : '' : 'pt-BR') : '-' }}</td>
        <td class="text-sm">{{ order.end_date ? (order.end_date | date: 'dd/MM/yy' : '' : 'pt-BR') : '-' }}</td>
        <td class="text-sm">{{ order.total_value | currency: 'USD' : 'symbol' : '1.2-2' : 'en-US' }}</td>
        <td class="text-sm">{{ order.booster_value | currency: 'USD' : 'symbol' : '1.2-2' : 'en-US' }}</td>
        <td>
          <p-button
            icon="pi pi-tag"
            [rounded]="true"
            [text]="true"
            severity="secondary"
            pTooltip="Details"
            tooltipPosition="top"
            (click)="openViewDialog(order)"
            title="Visualizar"
          />
          <p-button
            icon="pi pi-pencil"
            [rounded]="true"
            [text]="true"
            severity="success"
            pTooltip="Edit"
            tooltipPosition="top"
            (click)="editOrder(order)"
            title="Editar"
          />
          <p-button
            icon="pi pi-trash"
            [rounded]="true"
            [text]="true"
            severity="danger"
            pTooltip="Remove"
            tooltipPosition="top"
            (click)="confirmDelete(order)"
            title="Excluir"
          />
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr>
        <td [attr.colspan]="9" class="py-20">
          <div class="flex flex-col items-center justify-center">
            <div class="w-20 h-20 flex items-center justify-center mt-8">
              <i class="pi pi-box text-yellow-500" style="font-size: 2.5rem"></i>
            </div>
            <h3 class="font-bold text-xl text-gray-900 mb-1">No orders yet</h3>
            <p class="text-gray-500 text-base mb-8">This is where you will view and manage Orders.</p>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
  <p-confirmDialog></p-confirmDialog>
</div>

<!-- FORMULÁRIO DE New Order (modal ou inline) -->
<app-order-form *ngIf="showOrderForm" (close)="closeOrderForm()" />

<p-dialog
  header="Detalhes do Pedido"
  [(visible)]="viewDialogVisible"
  [modal]="true"
  [style]="{ width: '450px' }"
  [closable]="true"
  (onHide)="closeViewDialog()"
>
  <ng-container *ngIf="orderToView">
    <div class="flex flex-col gap-3">
      <div><b>Order number:</b> #{{ orderToView.order_number }}</div>
      <div><b>Booster:</b> {{ orderToView.booster }}</div>
      <div><b>Service type:</b> {{ orderToView.service_type }}</div>
      <div *ngIf="orderToView.weapon_quantity"><b>Qty. Weapons:</b> {{ orderToView.weapon_quantity }}</div>
      <div><b>Supplier:</b> {{ orderToView.supplier }}</div>
      <div><b>Status:</b> {{ orderToView.status }}</div>
      <div><b>Start date:</b> {{ orderToView.start_date | date: 'dd/MM/yyyy HH:mm' }}</div>
      <div><b>End date:</b> {{ orderToView.end_date | date: 'dd/MM/yyyy HH:mm' }}</div>
      <div><b>Total value:</b> R$ {{ orderToView.total_value | number: '1.2-2' }}</div>
      <div><b>Booster value:</b> R$ {{ orderToView.booster_value | number: '1.2-2' }}</div>
      <div><b>Notes:</b> {{ orderToView.observation }}</div>
    </div>
  </ng-container>
</p-dialog>
