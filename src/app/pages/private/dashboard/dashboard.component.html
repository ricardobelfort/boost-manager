<div class="mt-4">
  <ng-container *ngIf="isRoot; else childView">
    <div class="w-full flex justify-between items-center mb-8">
      <h2 class="!text-3xl font-bold text-black">Dashboard</h2>
      <button
        class="ml-4 px-5 py-3 bg-lime-500 hover:bg-lime-600 text-white rounded-lg font-semibold shadow transition cursor-pointer"
        routerLink="orders/select-game"
      >
        + New Order
      </button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
      <ng-container *ngIf="cards$ | async as cards">
        <ng-container *ngFor="let card of cards; let i = index">
          <div
            class="cursor-pointer transition-transform hover:-translate-y-1 focus:ring-2 focus:ring-lime-500"
            tabindex="0"
            role="button"
            [attr.aria-label]="'Go to ' + card.title"
            (click)="navigateToCard(card)"
            (keydown.enter)="navigateToCard(card)"
          >
            <app-dashboard-card
              [title]="card.title"
              [value]="card.value"
              [subtitleValue]="card.subtitleValue !== undefined ? card.subtitleValue.toString() : ''"
              [subtitleText]="card.subtitleText !== undefined ? card.subtitleText : ''"
              [subtitleValueColor]="card.subtitleValueColor !== undefined ? card.subtitleValueColor : ''"
              [subtitleTextColor]="card.subtitleTextColor !== undefined ? card.subtitleTextColor : ''"
              [iconClass]="card.iconClass !== undefined ? card.iconClass : ''"
              [iconBgClass]="card.iconBgClass !== undefined ? card.iconBgClass : ''"
              [valueColor]="card.valueColor !== undefined ? card.valueColor : ''"
            />
          </div>
        </ng-container>
      </ng-container>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Card Boosters Ativos -->
      <div class="bg-white rounded-xl shadow-sm p-6">
        <div class="text-lg font-semibold text-gray-700 mb-5">Active Boosters</div>
        <p-table [value]="activeBoosters" class="p-datatable-sm" [style]="{ width: '100%' }">
          <ng-template pTemplate="header">
            <tr>
              <th class="w-[80px]">#Order</th>
              <th>Booster</th>
              <th>Amount to Pay</th>
              <th class="w-[80px] !text-right">Actions</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-row>
            <tr>
              <td>{{ row.orderId }}</td>
              <td>
                <div class="flex items-center gap-2">
                  <img [src]="row.avatar" class="w-8 h-8 rounded-full" *ngIf="row.avatar" />
                  <span class="font-medium text-gray-800">{{ row.name }}</span>
                </div>
              </td>
              <td>
                <span class="font-semibold text-gray-700">{{ row.amount | currency: 'BRL' : 'symbol' : '1.2-2' }}</span>
              </td>
              <td class="!text-right">
                <p-button
                  icon="pi pi-search"
                  [rounded]="true"
                  severity="info"
                  [outlined]="true"
                  [pTooltip]="'View Report'"
                  tooltipPosition="top"
                  (click)="viewBoosterReport(row)"
                ></p-button>
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="4" class="text-gray-400 italic text-center py-4">No active boosters</td>
            </tr>
          </ng-template>
        </p-table>
      </div>

      <!-- Card Pedidos em Progresso -->
      <div class="bg-white rounded-xl shadow-sm p-6">
        <div class="w-full flex justify-between items-center border-b-gray-400 mb-5">
          <div class="text-lg font-semibold text-gray-700">Orders In Progress</div>
          <a routerLink="/dashboard/orders-in-progress" class="hover:text-lime-500 cursor-pointer hover:underline"
            >View All</a
          >
        </div>
        <p-table [value]="ordersInProgress" class="p-datatable-sm" [style]="{ width: '100%' }">
          <ng-template pTemplate="header">
            <tr>
              <th>Booster</th>
              <th>Service</th>
              <th>Progress</th>
              <th class="w-[80px] !text-center">Actions</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-row>
            <tr>
              <td>
                <span class="font-medium text-gray-800">{{ row.boosterName }}</span>
              </td>
              <td>
                <span class="text-gray-500">{{ row.serviceName }}</span>
              </td>
              <td class="flex flex-col gap-2">
                <div class="flex items-center gap-2">
                  <div class="w-30 h-2 bg-gray-100 rounded">
                    <div [ngClass]="row.progressBarColor" class="h-2 rounded" [style.width.%]="row.progress"></div>
                  </div>
                  <span [ngClass]="row.progressColor" class="font-semibold text-xs">{{ row.progressLabel }}</span>
                </div>
                <div class="flex flex-col gap-1">
                  <div class="text-xs text-gray-400">Started: {{ row.startedAt | date: 'dd/MM/yyyy HH:mm' }}</div>
                  <div class="flex items-center gap-1">
                    <i class="pi pi-clock !text-xs text-blue-500" pTooltip="Time Opened"></i>
                    <span class="ml-2 text-xs text-blue-500 font-mono">
                      <ng-container *ngIf="!row.concluded; else finished">
                        {{ row.timeOpen | async }}
                      </ng-container>
                      <ng-template #finished>
                        {{ row.finishedTime }}
                      </ng-template>
                    </span>
                  </div>
                </div>
              </td>
              <td class="w-[80px] !text-center">
                <ng-container *ngIf="!row.concluded; else concludedIcon">
                  <button
                    pButton
                    [icon]="
                      row.concluding
                        ? 'pi pi-spin pi-spinner'
                        : row.concludingRequested
                          ? 'pi pi-check-circle'
                          : 'pi pi-stop-circle'
                    "
                    class="p-button-rounded p-button-text"
                    [ngClass]="row.concluding ? 'p-button-secondary' : 'p-button-danger'"
                    (click)="row.concluding ? null : startConclude(row)"
                    [disabled]="row.concluding"
                    [pTooltip]="
                      row.concluding ? 'Finalizando...' : row.concludingRequested ? 'Finish requested' : 'Complete task'
                    "
                    tooltipPosition="top"
                  ></button>
                </ng-container>
                <ng-template #concludedIcon>
                  <i class="pi pi-check text-emerald-500 text-xl" pTooltip="ConcluÃ­do"></i>
                </ng-template>
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="4" class="text-gray-400 italic text-center py-4">No orders in progress</td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </div>
  </ng-container>
  <ng-template #childView>
    <div class="mt-6">
      <router-outlet />
    </div>
  </ng-template>
</div>
